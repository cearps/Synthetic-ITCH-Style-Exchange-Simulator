# ── Shared connection config ─────────────────────────────────────────
# Change these anchors (or use a .env override) to point at
# managed Kafka / ClickHouse — nothing else needs to change.
x-kafka-env: &kafka-env
  KAFKA_BROKERS: kafka:9092
  KAFKA_TOPIC: exchange.events

services:
  # ── Original services ──────────────────────────────────────────────
  build:
    build:
      context: ..
      dockerfile: docker/Dockerfile.build
    volumes:
      - output:/app/output
    working_dir: /app

  test:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    working_dir: /app
    command: ["/app/build/tests", "--gtest_color=yes"]

  simulator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.build
    volumes:
      - output:/app/output
    working_dir: /app
    command: ["/app/build/qrsdp_run", "--seed", "42", "--days", "5", "--output", "/app/output/run_42"]

  notebooks:
    build:
      context: ..
      dockerfile: docker/Dockerfile.notebooks
    volumes:
      - output:/app/output
    ports:
      - "8888:8888"

  # ── Streaming data platform (profile: platform) ───────────────────
  kafka:
    image: apache/kafka:3.7.0
    hostname: kafka
    profiles: [platform]
    restart: unless-stopped
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_LOG_DIRS: /tmp/kraft-combined-logs
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_NUM_PARTITIONS: 3
      CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qk"
    healthcheck:
      test: /opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  clickhouse:
    image: clickhouse/clickhouse-server:24.3
    hostname: clickhouse
    profiles: [platform]
    restart: unless-stopped
    ports:
      - "8123:8123"
      - "9009:9000"
    environment:
      <<: *kafka-env
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: changeme
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ../pipeline/clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql.template:ro
      - ../pipeline/clickhouse/init.sh:/docker-entrypoint-initdb.d/init.sh:ro
    depends_on:
      kafka:
        condition: service_healthy
    healthcheck:
      test: clickhouse-client --password changeme --query "SELECT 1" || exit 1
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  kafka-producer:
    build:
      context: ..
      dockerfile: docker/Dockerfile.kafka-producer
    profiles: [platform]
    restart: unless-stopped
    stop_grace_period: 10s
    environment:
      <<: *kafka-env
    depends_on:
      kafka:
        condition: service_healthy
    volumes:
      - output:/app/output
    command:
      - "--seed"
      - "42"
      - "--days"
      - "0"
      - "--seconds"
      - "23400"
      - "--output"
      - "/app/output/kafka_run_42"
      - "--kafka-brokers"
      - "kafka:9092"
      - "--kafka-topic"
      - "exchange.events"
      - "--securities"
      - "AAPL:10000,MSFT:15000,GOOG:12000"
      - "--market-open"
      - "09:30"
      - "--realtime"
      - "--speed"
      - "100"

  itch-stream:
    build:
      context: ..
      dockerfile: docker/Dockerfile.kafka-producer
    profiles: [platform]
    restart: unless-stopped
    stop_grace_period: 5s
    environment:
      <<: *kafka-env
    depends_on:
      kafka:
        condition: service_healthy
      itch-listener:
        condition: service_started
    entrypoint: ["/app/build/qrsdp_itch_stream"]
    command:
      - "--kafka-brokers"
      - "kafka:9092"
      - "--kafka-topic"
      - "exchange.events"
      - "--unicast-dest"
      - "itch-listener:5001"

  itch-listener:
    build:
      context: ..
      dockerfile: docker/Dockerfile.kafka-producer
    profiles: [platform]
    entrypoint: ["/app/build/qrsdp_listen"]
    command: ["--port", "5001", "--no-multicast"]


volumes:
  output:
  clickhouse-data:
