# ADR 0005: Python Visualization and CSV Export for Testing

## Status

Accepted

## Context

Issue #21 required implementing a full simulation pipeline with visualization tools to assess simulation progress and sanity. The simulator generates a deterministic event log containing order events, trade events, and book updates. Before encoding this data into ITCH format and streaming over UDP, we need a way to:

1. **Validate simulation correctness**: Verify that the matching engine produces correct results, that invariants hold, and that determinism works
2. **Inspect market behavior**: Understand price movements, trading patterns, and order flow characteristics
3. **Debug issues**: Identify problems in the simulation pipeline before investing in ITCH encoding
4. **Compare different seeds**: Evaluate how different random seeds produce different but deterministic market scenarios

Constraints:
- Must work in Windows development environment
- Should be lightweight and easy to use
- Must not require complex dependencies or infrastructure
- Should provide both quick inspection and detailed analysis
- Output should be human-readable and suitable for external tools
- Must integrate with existing C++ codebase

## Decision

We will implement a CSV export feature in the C++ simulator and a Python visualization script to analyze the exported data. This provides a lightweight, cross-platform solution for testing and validation before implementing ITCH encoding.

### Implementation Approach

1. **CSV Export in C++ Simulator**:
   - Export trade data (timestamp, sequence number, price, quantity, order IDs) to CSV
   - Filename includes seed: `price_data_seed_<seed>.csv`
   - Simple, human-readable format for easy inspection
   - Written to `data/` directory (mounted as Docker volume)

2. **Python Visualization Script**:
   - Reads CSV files generated by the simulator
   - Generates comprehensive visualization dashboard with multiple charts:
     - Price over time (main chart)
     - Price distribution histogram
     - Trading volume over time
     - Price change distribution
     - Volume-weighted average price (VWAP)
   - Output images tagged with seed: `price_visualization_seed_<seed>.png`
   - Prints summary statistics to console
   - Uses pandas and matplotlib (standard Python data science libraries)

3. **Workflow**:
   - Run simulator with seed → generates CSV
   - Run Python script on CSV → generates visualizations
   - Inspect results to validate simulation behavior
   - Iterate on simulation parameters or seed values

### File Naming Convention

- CSV files: `data/price_data_seed_<seed>.csv`
- Visualization images: `data/price_visualization_seed_<seed>.png` and `data/price_simple_seed_<seed>.png`
- Seed is extracted from CSV filename and included in image filenames for traceability

## Alternatives considered

- **Binary format export (e.g., Parquet, Arrow)**
  - Rejected: Requires additional C++ libraries, less human-readable, harder to debug

- **Direct ITCH encoding and inspection**
  - Rejected: ITCH is complex binary format, harder to debug, premature optimization before validating simulation

- **C++ visualization (e.g., using a plotting library)**
  - Rejected: More complex dependencies, harder to iterate on visualizations, less flexible

- **Database storage (e.g., SQLite, DuckDB)**
  - Rejected: Overkill for testing phase, adds complexity, CSV is sufficient for validation

- **JSON export**
  - Rejected: Larger file size, slower to parse, CSV is more efficient for tabular trade data

- **Terminal-only visualization (ASCII charts)**
  - Rejected: Limited detail, hard to compare multiple seeds, not suitable for detailed analysis

- **External visualization tools only (no CSV export)**
  - Rejected: Need programmatic access to data, CSV provides flexibility for custom analysis

## Consequences

- **Pros:**
  - Lightweight: CSV is simple, human-readable, works everywhere
  - Fast iteration: Easy to generate new data and visualize
  - Cross-platform: Python works on Windows, Linux, macOS
  - Flexible: CSV can be opened in Excel, loaded into other tools
  - Clear traceability: Seed in filename links simulation to visualization
  - Comprehensive: Multiple chart types provide different insights
  - Standard tools: pandas/matplotlib are well-established libraries

- **Cons:**
  - Requires Python environment setup (mitigated by virtual environment scripts)
  - CSV files can be large for long simulations (acceptable for testing phase)
  - Not real-time: Must run simulation, then visualize (acceptable for validation workflow)
  - Additional dependency: Python packages (pandas, matplotlib)

- **Follow-on work:**
  - Add more visualization types (order book depth, spread over time, etc.)
  - Add comparison tools to visualize multiple seeds side-by-side
  - Consider adding statistical analysis (volatility metrics, autocorrelation, etc.)
  - Add configuration options for chart styling and output format
  - Consider adding interactive visualization (e.g., using Plotly) for exploration
  - Document visualization workflow in README

## Implementation Details

### CSV Export

The CSV export is implemented in `ExchangeSimulator::export_price_data_to_csv()`:

```cpp
// Exports trade events to CSV with columns:
// timestamp_ns, sequence_number, price, quantity, buy_order_id, sell_order_id
std::ofstream file(filename);
file << "timestamp_ns,sequence_number,price,quantity,buy_order_id,sell_order_id\n";
for (const auto& trade : trade_events) {
    file << trade.timestamp.nanoseconds_since_epoch << ","
         << trade.sequence_number << ","
         << trade.price.value << ","
         << trade.quantity.value << ","
         << trade.buy_order_id.value << ","
         << trade.sell_order_id.value << "\n";
}
```

### Python Visualization

The Python script (`tools/visualize_price_data.py`):
- Automatically detects seed from CSV filename using regex
- Generates 6-panel dashboard with comprehensive charts
- Tags output images with seed for traceability
- Provides summary statistics in console output

### Usage

```bash
# Run simulator with seed 42
docker-compose run --rm simulator /app/build/itch_simulator 42

# Visualize the results
python tools/visualize_price_data.py data/price_data_seed_42.csv
```

## Notes / References

- Issue #21: Full simulation pipeline implementation
- CSV format: Standard, human-readable tabular data format
- Python visualization: Uses pandas for data manipulation and matplotlib for plotting
- Virtual environment: Setup scripts provided in `tools/setup_venv.sh` and `tools/setup_venv.ps1`
- Implementation:
  - CSV export: `src/exchange_simulator.cpp` (`export_price_data_to_csv`)
  - Python script: `tools/visualize_price_data.py`
  - Documentation: `tools/README.md`
- Future: This CSV export and visualization approach is intended for testing and validation. Once the simulation is validated, ITCH encoding will be implemented for the final UDP streaming output.

